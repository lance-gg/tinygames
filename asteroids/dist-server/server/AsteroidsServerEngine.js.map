{"version":3,"sources":["../../src/server/AsteroidsServerEngine.js"],"names":["AsteroidsServerEngine","io","gameEngine","inputOptions","physicsEngine","world","on","handleCollision","bind","shoot","addAsteroids","evt","A","B","forEachObject","id","obj","physicsObj","bodyA","bodyB","trace","toString","Bullet","Asteroid","explode","Ship","kill","queryObjects","instanceType","length","player","radius","shapes","angle","Math","PI","bullet","mass","position","TwoVector","cos","sin","velocity","angularVelocity","addObjectToWorld","timer","add","bulletLifeTime","destroyBullet","bulletId","objects","removeObjectFromWorld","ship","lives","socket","addShip","playerId","socketId","o","ServerEngine"],"mappings":"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","sourcesContent":["import { ServerEngine, TwoVector } from 'lance-gg';\nimport Asteroid from '../common/Asteroid';\nimport Bullet from '../common/Bullet';\nimport Ship from '../common/Ship';\n\nexport default class AsteroidsServerEngine extends ServerEngine {\n\n    constructor(io, gameEngine, inputOptions) {\n        super(io, gameEngine, inputOptions);\n        gameEngine.physicsEngine.world.on('beginContact', this.handleCollision.bind(this));\n        gameEngine.on('shoot', this.shoot.bind(this));\n    }\n\n    start() {\n        super.start();\n        this.gameEngine.addAsteroids();\n    }\n\n    // handle a collision on server only\n    handleCollision(evt) {\n\n        // identify the two objects which collided\n        let A;\n        let B;\n        this.gameEngine.world.forEachObject((id, obj) => {\n            if (obj.physicsObj === evt.bodyA) A = obj;\n            if (obj.physicsObj === evt.bodyB) B = obj;\n        });\n\n        // check bullet-asteroid and ship-asteroid collisions\n        if (!A || !B) return;\n        this.gameEngine.trace.trace(() => `collision between A=${A.toString()}`);\n        this.gameEngine.trace.trace(() => `collision and     B=${B.toString()}`);\n        if (A instanceof Bullet && B instanceof Asteroid) this.gameEngine.explode(B, A);\n        if (B instanceof Bullet && A instanceof Asteroid) this.gameEngine.explode(A, B);\n        if (A instanceof Ship && B instanceof Asteroid) this.kill(A);\n        if (B instanceof Ship && A instanceof Asteroid) this.kill(B);\n\n        // restart game\n        if (this.gameEngine.world.queryObjects({ instanceType: Asteroid }).length === 0) this.gameEngine.addAsteroids();\n    }\n\n    // shooting creates a bullet\n    shoot(player) {\n\n        let radius = player.physicsObj.shapes[0].radius;\n        let angle = player.physicsObj.angle + Math.PI / 2;\n        let bullet = new Bullet(this.gameEngine, {}, {\n            mass: 0.05,\n            position: new TwoVector(\n                radius * Math.cos(angle) + player.physicsObj.position[0],\n                radius * Math.sin(angle) + player.physicsObj.position[1]\n            ),\n            velocity: new TwoVector(\n                2 * Math.cos(angle) + player.physicsObj.velocity[0],\n                2 * Math.sin(angle) + player.physicsObj.velocity[1]\n            ),\n            angularVelocity: 0\n        });\n        let obj = this.gameEngine.addObjectToWorld(bullet);\n        this.gameEngine.timer.add(this.gameEngine.bulletLifeTime, this.destroyBullet, this, [obj.id]);\n    }\n\n    // destroy the missile if it still exists\n    destroyBullet(bulletId) {\n        if (this.gameEngine.world.objects[bulletId]) {\n            this.gameEngine.trace.trace(() => `bullet[${bulletId}] destroyed`);\n            this.gameEngine.removeObjectFromWorld(bulletId);\n        }\n    }\n\n    kill(ship) {\n        if(ship.lives-- === 0) this.gameEngine.removeObjectFromWorld(ship.id);\n    }\n\n    onPlayerConnected(socket) {\n        super.onPlayerConnected(socket);\n        this.gameEngine.addShip(socket.playerId);\n    }\n\n    onPlayerDisconnected(socketId, playerId) {\n        super.onPlayerDisconnected(socketId, playerId);\n        for (let o of this.gameEngine.world.queryObjects({ playerId }))\n            this.gameEngine.removeObjectFromWorld(o.id);\n    }\n}\n"],"file":"AsteroidsServerEngine.js"}